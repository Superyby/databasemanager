# 1. 项目简介
高性能数据库(后端),基于（Rust + Axum + SQLx）
## 1.1 核心目标
安全地管理多种数据库连接（MySQL/PostgreSQL/SQLite/ClickHouse等），并支持执行 SQL 查询
## 1.2 模块细化
```text
src/
├── main.rs
├── routes/
│   ├── mod.rs
│   ├── health.rs
│   └── connections.rs      ← 新增：连接管理 API
├── models/
│   ├── mod.rs
│   └── connection.rs       ← ConnectionConfig, ConnectionStatus
├── services/
│   ├── mod.rs
│   └── connection_service.rs ← 创建/测试/删除连接
├── db/
│   ├── mod.rs
│   └── pool_manager.rs     ← 动态连接池管理（关键！）
├── errors/
│   ├── mod.rs
│   └── app_error.rs        ← 统一错误处理
└── utils/
    └── id_generator.rs     ← 生成唯一连接 ID（如 UUID）
```
## 1.3 关键数据模型(models/connection.rs)
```text
use serde::{Deserialize, Serialize};

#[derive(Serialize, Deserialize, Clone)]
pub struct ConnectionConfig {
    pub id: String,           // 唯一ID（前端生成或后端分配）
    pub name: String,         // 连接别名（如 "生产库"）
    pub r#type: DbType,       // mysql / postgres / sqlite
    pub host: Option<String>,
    pub port: Option<u16>,
    pub username: Option<String>,
    pub password: Option<String>,
    pub database: Option<String>,
    pub file_path: Option<String>, // SQLite 专用
}

#[derive(Serialize, Deserialize, Clone)]
pub enum DbType {
    #[serde(rename = "mysql")]
    MySQL,
    #[serde(rename = "postgres")]
    Postgres,
    #[serde(rename = "sqlite")]
    SQLite,
}

#[derive(Serialize)]
pub struct ConnectionStatus {
    pub id: String,
    pub is_connected: bool,
    pub error_message: Option<String>,
}
```
使用 serde(rename = "...") 确保 JSON 字段名是小写（如 "mysql"），方便前端使用。
# 2. 核心服务 动态连接池（db/pool_manager.rs）
Rust 需要在运行时根据用户输入创建不同类型的数据库连接池。
```rust
use std::collections::HashMap;
use std::sync::Arc;
use tokio::sync::RwLock;
use sqlx::{MySqlPool, PostgresPool, SqlitePool};

pub struct PoolManager {
    mysql_pools: RwLock<HashMap<String, MySqlPool>>,
    postgres_pools: RwLock<HashMap<String, PostgresPool>>,
    sqlite_pools: RwLock<HashMap<String, SqlitePool>>,
}

impl PoolManager {
    pub fn new() -> Self {
        Self {
            mysql_pools: RwLock::new(HashMap::new()),
            postgres_pools: RwLock::new(HashMap::new()),
            sqlite_pools: RwLock::new(HashMap::new()),
        }
    }

    pub async fn add_connection(&self, config: &ConnectionConfig) -> Result<(), AppError> {
        match config.r#type {
            DbType::MySQL => {
                let url = format!("mysql://{}:{}@{}:{}/{}", 
                    config.username.as_ref().unwrap_or(&"root".to_string()),
                    config.password.as_ref().unwrap_or(&"".to_string()),
                    config.host.as_deref().unwrap_or("localhost"),
                    config.port.unwrap_or(3306),
                    config.database.as_deref().unwrap_or(""),
                );
                let pool = MySqlPool::connect(&url).await?;
                self.mysql_pools.write().await.insert(config.id.clone(), pool);
            }
            // 类似处理 Postgres 和 SQLite...
        }
        Ok(())
    }

    pub async fn test_connection(&self, id: &str, db_type: &DbType) -> bool {
        // 尝试从对应池中取连接并执行简单查询（如 SELECT 1）
    }
}
```
关键点：
- 用 RwLock<HashMap<...>> 安全存储多个连接池
- 每个连接有唯一 id，前端通过 id 指定操作哪个数据库


# 3. API接口设计(前后端契约)
| 功能 | 方法 | 路径 | 请求体 | 响应 |
|------|------|------|--------|------|
| 获取所有连接 | GET | `/api/connections` | - | `ConnectionConfig[]` |
| 新建连接 | POST | `/api/connections` | `ConnectionConfig` | `{ id: string }` |
| 测试连接 | POST | `/api/connections/:id/test` | - | `ConnectionStatus` |
| 删除连接 | DELETE | `/api/connections/:id` | - | `{ success: true }` |
| 执行 SQL | POST | `/api/connections/:id/query` | `{ sql: "SELECT ..." }` | `{ columns: [], rows: [] }` |

先实现前 3 个（MVP），再做 SQL 执行


# 4. 编写步骤
┌─────────────────────────────────────────────────────┐
│                   connection-service                 │
├─────────────────────────────────────────────────────┤
│  routes.rs      │  只定义路由映射（16行）            │
│                 │  .route("/api/xxx", get(handler))  │
├─────────────────┼───────────────────────────────────┤
│  handlers.rs    │  只写接口处理函数（214行）         │
│                 │  async fn list_connections()       │
├─────────────────┼───────────────────────────────────┤
│  service.rs     │  业务逻辑                          │
│                 │  ConnectionService::create()       │
├─────────────────┼───────────────────────────────────┤
│  state.rs       │  共享状态（连接池等）              │
└─────────────────┴───────────────────────────────────┘