# AI 架构设计

> DatabaseManager 智能查询系统设计文档

## 1. 概述

### 1.1 设计目标

将 AI 从辅助功能升级为贯穿查询生命周期的核心能力，构建可控、可审计、可评测、可扩展的智能查询体系。

### 1.2 核心能力

| 能力 | 说明 |
|------|------|
| Text2SQL | 自然语言转 SQL 查询 |
| 语义理解 | 指标、维度、口径的统一建模与解释 |
| RAG 增强 | 历史 SQL、FAQ、指标定义的检索增强 |
| 安全治理 | 权限控制、数据脱敏、只读执行、审计追溯 |

### 1.3 设计原则

- **最小权限**：默认只读，逐层授权
- **可解释**：所有生成与执行均可审计追溯
- **可回归**：内置评测集与 CI 回归机制
- **可扩展**：模型与检索源支持热插拔

### 1.4 当前不支持

- 跨库联邦查询
- 写操作（INSERT / UPDATE / DELETE）
- 自研模型训练

---

## 2. 系统架构

### 2.1 分层架构

```
┌─────────────────────────────────────────────────────────┐
│                      表现层                              │
│         交互界面 · 多轮对话 · SQL 编辑与解释              │
├─────────────────────────────────────────────────────────┤
│                    AI 编排层                             │
│      意图解析 · 生成验证 · 执行链路 · 策略路由            │
├─────────────────────────────────────────────────────────┤
│                   数据语义层                             │
│         指标定义 · 维度管理 · 口径规则 · 数据画像         │
├─────────────────────────────────────────────────────────┤
│                   数据访问层                             │
│          Schema 管理 · 连接池 · 只读执行器               │
├─────────────────────────────────────────────────────────┤
│                     治理层                               │
│       权限控制 · 数据脱敏 · 审计日志 · 监控告警           │
└─────────────────────────────────────────────────────────┘
```

### 2.2 核心流程

```
用户输入 ──▶ 意图解析 ──▶ 语义补全 ──▶ RAG 检索
                                          │
    ┌─────────────────────────────────────┘
    ▼
SQL 生成 ──▶ 规则校验 ──▶ EXPLAIN 预检 ──▶ 执行查询
                                          │
    ┌─────────────────────────────────────┘
    ▼
结果解释 ──▶ 审计记录 ──▶ 用户反馈 ──▶ 闭环优化
```

---

## 3. 核心模块

### 3.1 意图解析模块

**职责**：理解用户查询意图，必要时触发澄清对话

| 意图类型 | 示例 |
|----------|------|
| 筛选查询 | "查找北京地区的用户" |
| 聚合统计 | "统计每月订单总额" |
| 趋势分析 | "最近 30 天的销售趋势" |
| 对比分析 | "对比 Q1 和 Q2 的收入" |

**澄清触发条件**：
- 时间范围缺失
- 指标口径不明确
- 维度粒度模糊

**多轮澄清协议**：

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| 最大澄清轮次 | 3 | 超过后终止并返回最佳猜测或提示重述 |
| 单轮超时 | 120s | 用户未响应则提示或自动采用默认值 |
| 澄清间隔 | 无连续澄清 | 同一维度不连续追问，合并多维度一次询问 |

**澄清触发规则**：
```
置信度 < 0.7 且 存在歧义维度 → 触发澄清
置信度 < 0.5 → 强制澄清，不生成 SQL
置信度 >= 0.7 且 无歧义 → 直接生成
```

**用户拒绝澄清时的策略**：
- 采用业务默认值（如时间默认近 7 天，地区默认全部）
- 生成 SQL 时标注"已采用默认口径"
- 置信度评分下调 0.1，并在引用来源中注明

### 3.2 语义层模块（SemanticLayer）

**职责**：统一业务术语与数据模型的映射

```
业务名词 ──▶ 标准指标/维度 ──▶ 物理字段
   │              │               │
 "销售额"     metric:gmv      orders.amount
```

**核心能力**：
- 指标定义与版本管理
- 维度层级与关联
- 口径规则与默认值补全

**数据血缘与口径追溯**：

指标计算依赖链定义：
```json
{
  "metric_id": "gmv",
  "name": "销售额",
  "formula": "SUM(orders.amount)",
  "dependencies": [
    {"type": "table", "name": "orders", "columns": ["amount", "status"]},
    {"type": "filter", "condition": "status = 'completed'"}
  ],
  "upstream_metrics": [],
  "version": "2024-01-15",
  "owner": "data-team"
}
```

血缘摘要输出格式（附加于生成的 SQL）：
```json
{
  "lineage_summary": {
    "source_tables": ["orders", "users"],
    "key_columns": ["orders.amount", "orders.created_at", "users.region"],
    "applied_rules": ["rule:gmv_calculation", "rule:active_user_filter"],
    "metric_versions": {"gmv": "2024-01-15", "user_count": "2024-01-10"}
  }
}
```

血缘用途：
- 审计追溯：快速定位数据来源与计算逻辑
- 影响分析：Schema 变更时评估受影响的指标
- 口径校验：对比不同时期的计算逻辑差异

### 3.3 RAG 检索模块（RAGSearch）

**职责**：检索相关上下文增强生成质量

| 语料类型 | 用途 |
|----------|------|
| 历史 SQL | 相似查询复用 |
| FAQ | 常见问题直接匹配 |
| 指标定义 | 口径与计算逻辑 |
| 示例问答 | Few-shot 参考 |

**质量与安全控制**：
- 权限隔离：按用户/角色过滤可见语料
- 去噪与去重：低质量或过期语料剔除
- 召回与重排：先召回后重排，设置最低相关性阈值
- 注入防护：过滤指令型与敏感泄露内容

**语料质量治理机制**：

| 治理维度 | 规则 | 动作 |
|----------|------|------|
| 时效性 | 超过 180 天未命中 | 标记为待审核 |
| 准确性 | 用户负反馈 >= 3 次 | 自动下线 |
| 相关性 | 召回后点击率 < 5% | 降低权重 |
| 口径一致性 | 关联指标版本过期 | 触发更新提醒 |

语料评分模型：
```
score = 0.3 * recency + 0.3 * accuracy + 0.2 * relevance + 0.2 * feedback
```

- `recency`：最近命中时间衰减分（180 天半衰期）
- `accuracy`：执行成功率
- `relevance`：语义相似度均值
- `feedback`：用户正向反馈率

淘汰规则：
- `score < 0.3`：自动归档，不参与召回
- `score < 0.5`：仅在无更优结果时召回
- 定期（每月）执行全量评分刷新

### 3.4 SQL 生成模块（SQLGenerator）

**职责**：基于上下文生成 SQL

**输入**：
- 用户问题 + 对话历史
- Schema 信息
- 语义层定义
- RAG 检索结果

**输出**：
- SQL 语句
- 自然语言解释
- 置信度评分
- 引用来源

**置信度与引用说明**：
- 置信度由语义匹配、Schema 覆盖、RAG 命中质量、SQL 规则校验综合得出
- 引用来源需包含语料类型与标识（如 metric:gmv, faq:123）

**SQL 方言差异适配**：

| 差异点 | MySQL | PostgreSQL | SQLite |
|--------|-------|------------|--------|
| 分页 | `LIMIT n OFFSET m` | `LIMIT n OFFSET m` | `LIMIT n OFFSET m` |
| 字符串连接 | `CONCAT(a, b)` | `a || b` | `a || b` |
| 当前时间 | `NOW()` | `NOW()` | `datetime('now')` |
| 日期格式化 | `DATE_FORMAT(d, '%Y-%m')` | `TO_CHAR(d, 'YYYY-MM')` | `strftime('%Y-%m', d)` |
| 日期加减 | `DATE_ADD(d, INTERVAL 7 DAY)` | `d + INTERVAL '7 days'` | `date(d, '+7 days')` |
| IFNULL | `IFNULL(a, b)` | `COALESCE(a, b)` | `IFNULL(a, b)` |
| 布尔类型 | `1/0` | `true/false` | `1/0` |
| 标识符引用 | `` `name` `` | `"name"` | `"name"` 或 `` `name` `` |

适配策略：
- 生成阶段：根据连接的数据库类型选择对应方言模板
- 函数映射表：维护跨方言的函数等价映射
- 语法校验：按目标方言进行 AST 校验
- Prompt 注入：在系统提示中明确当前方言约束

### 3.5 SQL 校验模块（SQLGuardrails）

**职责**：确保 SQL 安全合规

| 规则 | 说明 |
|------|------|
| 只读检查 | 仅允许 SELECT 语句 |
| 单语句限制 | 禁止多语句执行 |
| 关键词过滤 | 拦截危险操作 |
| LIMIT 强制 | 默认添加结果限制 |
| 字段校验 | 验证字段存在性 |

### 3.6 执行预检模块（ExplainChecker）

**职责**：评估查询执行风险

**检查项**：
- 全表扫描检测
- 预估扫描行数
- 执行代价评估

**处理策略**：
- 低风险：直接执行
- 中风险：提示用户确认
- 高风险：拒绝并建议优化

**风险阈值建议**：
- 扫描行数、成本估计、索引命中率三类阈值
- 阈值可按数据库类型配置，并支持灰度调整

### 3.7 Schema 管理模块（SchemaManager）

**职责**：维护数据库元数据

**能力**：
- Schema 拉取与缓存
- TTL 过期与自动刷新
- 变更检测与通知

**变更与降级策略**：
- 变更检测：定时比对 + 事件触发（如 DDL 审计日志）
- 失败回退：使用最近可用缓存并提示用户
- 降级路径：禁用写法复杂的自动补全，仅保留安全查询

### 3.8 数据画像模块（DataProfile）

**职责**：提供字段统计信息辅助生成

| 画像项 | 说明 |
|--------|------|
| 基数 | 字段唯一值数量 |
| 空值率 | NULL 占比 |
| 时间覆盖 | 时间字段的数据范围 |
| 值分布 | 高频值与分布特征 |

### 3.9 失败与降级策略

**职责**：定义各环节失败时的 fallback 逻辑，确保系统可用性

| 失败场景 | 降级策略 | 用户提示 |
|----------|----------|----------|
| Schema 读取失败 | 使用最近有效缓存（标记 stale） | "当前使用缓存元数据，可能与实际略有差异" |
| Schema 缓存也失效 | 拒绝生成，引导用户检查连接 | "无法获取数据库结构，请检查连接配置" |
| RAG 召回为空 | 仅依赖 Schema + 语义层生成 | 无额外提示，置信度下调 0.15 |
| RAG 服务不可用 | 同上，并记录告警 | 无额外提示，后台触发告警 |
| EXPLAIN 不支持 | 跳过预检，强制添加 LIMIT 100 | "当前数据库不支持执行计划预检，已限制返回行数" |
| EXPLAIN 超时 | 视为高风险，要求用户确认 | "执行计划分析超时，建议优化查询条件" |
| 模型调用失败 | 重试 2 次后返回错误 | "AI 服务暂时不可用，请稍后重试" |
| 模型响应超时 | 降级为快速模型重试 | 无额外提示 |
| SQL 执行超时 | 取消查询，返回部分结果（如支持） | "查询执行超时，请缩小查询范围" |

**降级优先级**：
```
缓存命中 > 降级模型 > 安全默认值 > 拒绝并提示
```

**熔断机制**：
- 连续失败 5 次：触发熔断，暂停该环节 60 秒
- 熔断期间：直接走降级路径，不尝试主路径
- 恢复探测：熔断结束后以 10% 流量探测恢复

---

## 4. 数据存储

### 4.1 存储表设计

| 表名 | 用途 |
|------|------|
| `ai_semantic_metric` | 指标定义 |
| `ai_semantic_dimension` | 维度定义 |
| `ai_semantic_rule` | 口径与解释规则 |
| `ai_schema_cache` | Schema 缓存 |
| `ai_profile_cache` | 字段画像缓存 |
| `ai_rag_corpus` | RAG 语料库 |
| `ai_audit_log` | 审计与反馈日志 |

**多租户隔离建议**：
- 语料与审计表增加 tenant_id 维度
- 索引与查询强制带租户条件

---

## 5. API 设计

### 5.1 接口列表

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/ai/query` | 自然语言查询 |
| POST | `/api/ai/clarify` | 澄清回复 |
| POST | `/api/ai/validate` | SQL 校验 |
| POST | `/api/ai/execute` | 执行查询 |
| GET | `/api/ai/schema` | 获取 Schema |
| GET | `/api/ai/metrics` | 查询指标定义 |

### 5.2 请求响应规范

**通用请求头**：
| 字段 | 必填 | 说明 |
|------|------|------|
| X-Request-Id | 是 | 客户端生成的请求唯一标识，用于幂等与追踪 |
| X-Trace-Id | 否 | 分布式追踪 ID，跨服务透传 |
| X-Idempotency-Key | 否 | 幂等键，用于 POST 请求去重 |

**幂等策略**：
- `/api/ai/query`：基于 `X-Idempotency-Key`，10 分钟内相同 key 返回缓存结果
- `/api/ai/execute`：基于 `request_id + sql_hash`，防止重复执行
- 幂等窗口：默认 10 分钟，可配置
- 冲突处理：返回 409 Conflict 并附带原请求结果

**请求结构**：
```json
{
  "request_id": "req_abc123",
  "question": "用户问题",
  "context": "对话上下文",
  "user_permissions": ["db:read", "table:orders"]
}
```

**响应结构**：
```json
{
  "request_id": "req_abc123",
  "trace_id": "trace_xyz789",
  "sql": "SELECT ...",
  "explanation": "自然语言解释",
  "confidence": 0.92,
  "references": ["metric:gmv", "faq:123"],
  "lineage_summary": {
    "source_tables": ["orders"],
    "applied_rules": ["rule:gmv_calculation"]
  }
}
```

**字段说明**：
- `confidence`：生成可信度评分，用于是否触发澄清或用户确认
- `references`：引用来源清单，便于追溯和审计

---

## 6. 安全与治理

### 6.1 权限控制

- 库级 / 表级 / 行级 / 列级权限
- 基于用户角色的访问控制
- 只读连接与事务隔离
- RAG 语料与审计日志的租户隔离

**权限评估时机与检查项**：

| 阶段 | 时机 | 检查项 | 失败处理 |
|------|------|--------|----------|
| 请求入口 | 接收请求时 | 用户身份验证、会话有效性、基础权限 | 401/403 拒绝 |
| RAG 检索前 | 语料召回前 | 语料可见性过滤（租户、角色） | 过滤不可见语料 |
| SQL 生成前 | Prompt 组装时 | Schema 可见范围、表/列访问权限 | 仅注入可访问的 Schema |
| SQL 生成后 | 生成完成时 | 解析 SQL 涉及的表/列是否越权 | 拒绝并提示无权限 |
| 执行前 | 提交执行前 | 二次校验表/列权限 + 行级过滤条件注入 | 拒绝或自动添加过滤条件 |
| 返回前 | 结果返回时 | 敏感列脱敏、结果行数限制 | 脱敏处理后返回 |

**权限穿透防护**：
- 双重校验：生成后与执行前均需校验，防止 Prompt 注入绕过
- 白名单机制：仅允许访问显式授权的表/列
- SQL 解析：使用 AST 解析而非正则，避免混淆攻击

### 6.2 数据脱敏

| 类型 | 脱敏规则 |
|------|----------|
| 手机号 | `138****8888` |
| 邮箱 | `a***@example.com` |
| 身份证 | `110***********1234` |
| 银行卡 | `6222 **** **** 1234` |

### 6.3 审计日志

记录内容：
- 原始问题与生成的 SQL
- 执行耗时与结果规模
- 用户反馈与评分
- 异常与错误信息

**审计表字段定义**：

```sql
CREATE TABLE ai_audit_log (
  id              BIGINT PRIMARY KEY AUTO_INCREMENT,
  request_id      VARCHAR(64) NOT NULL,      -- 请求唯一标识
  trace_id        VARCHAR(64),               -- 分布式追踪 ID
  tenant_id       VARCHAR(32) NOT NULL,      -- 租户标识
  user_id         VARCHAR(64) NOT NULL,      -- 用户标识
  session_id      VARCHAR(64),               -- 会话标识

  -- 请求信息
  question        TEXT NOT NULL,             -- 原始问题
  question_hash   VARCHAR(64),               -- 问题哈希（用于相似查询统计）
  context_summary TEXT,                      -- 上下文摘要

  -- 生成信息
  model_version   VARCHAR(32),               -- 使用的模型版本
  prompt_hash     VARCHAR(64),               -- Prompt 模板哈希
  generated_sql   TEXT,                      -- 生成的 SQL
  sql_hash        VARCHAR(64),               -- SQL 哈希
  confidence      DECIMAL(3,2),              -- 置信度评分
  references      JSON,                      -- 引用来源
  lineage_summary JSON,                      -- 血缘摘要

  -- 执行信息
  executed        BOOLEAN DEFAULT FALSE,     -- 是否执行
  execution_time  INT,                       -- 执行耗时(ms)
  result_rows     INT,                       -- 结果行数
  result_size     INT,                       -- 结果大小(bytes)
  risk_level      ENUM('low','medium','high'), -- 风险等级

  -- 状态与反馈
  status          ENUM('success','failed','rejected','timeout'),
  error_code      VARCHAR(32),
  error_message   TEXT,
  feedback_score  TINYINT,                   -- 用户评分(1-5)
  feedback_text   TEXT,                      -- 用户反馈文本

  -- 时间戳
  created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  INDEX idx_request_id (request_id),
  INDEX idx_trace_id (trace_id),
  INDEX idx_tenant_user (tenant_id, user_id),
  INDEX idx_created_at (created_at),
  INDEX idx_sql_hash (sql_hash)
);
```

**留存与访问**：
- 日志保留周期与脱敏策略
- 审计访问需受权限控制并记录访问日志

---

## 7. 成本控制

### 7.1 模型分级

| 级别 | 场景 | 特点 |
|------|------|------|
| 快速模型 | 简单查询、澄清对话 | 低延迟、低成本 |
| 高精度模型 | 复杂分析、多表关联 | 高准确率 |

**模型路由具体阈值**：

| 判定维度 | 快速模型 | 高精度模型 |
|----------|----------|------------|
| 涉及表数量 | <= 2 | > 2 |
| 预估 Token 数 | <= 2000 | > 2000 |
| 查询复杂度 | 无 JOIN / 子查询 | 包含 JOIN / 子查询 / 窗口函数 |
| 置信度要求 | >= 0.8 可接受 | < 0.8 需升级 |
| 用户等级 | 普通用户 | VIP / 企业用户 |

路由决策流程：
```
1. 解析问题复杂度 → 初步选择模型
2. 检查用户配额 → 配额不足则强制快速模型
3. 执行生成 → 置信度 < 0.7 且未用高精度 → 升级重试
4. 记录路由结果 → 用于后续优化分析
```

### 7.2 缓存策略

| 缓存层 | TTL | 说明 |
|--------|-----|------|
| Schema | 1h | 表结构变化触发刷新 |
| 语义层 | 配置 | 手动更新触发刷新 |
| 数据画像 | 24h | 定时任务刷新 |
| 相似查询 | 7d | 基于问题相似度命中 |

**缓存命中优先级**：
```
1. 精确查询缓存（question_hash 完全匹配）
2. 相似查询缓存（语义相似度 > 0.95）
3. SQL 结果缓存（sql_hash 匹配且数据未过期）
4. Schema/语义层缓存
5. 无缓存，执行完整生成流程
```

**Token 预算规则**：

| 用户等级 | 单次请求上限 | 日配额 | 月配额 |
|----------|--------------|--------|--------|
| 免费用户 | 2,000 tokens | 10,000 | 100,000 |
| 标准用户 | 4,000 tokens | 50,000 | 500,000 |
| 企业用户 | 8,000 tokens | 无限制 | 按合约 |

预算执行：
- 请求前预估 Token 消耗，超出单次上限则拒绝
- 接近日配额 80% 时提醒用户
- 超出日配额后降级为快速模型 + 限制功能

**失效与回退**：
- 变更感知触发主动刷新
- 缓存失效时优先走只读安全路径

### 7.3 限流配额

- 用户级别：请求频率 / Token 用量
- 组织级别：日 / 月配额上限
- 超限处理：降级 / 排队 / 拒绝

**超限降级动作**：
- 仅返回澄清问题或解释，不执行 SQL
- 降级为快速模型并限制结果规模

---

## 8. 评测与监控

### 8.1 评测体系

| 指标 | 说明 |
|------|------|
| SQL 正确率 | 生成 SQL 与标准答案的匹配度 |
| 执行成功率 | SQL 执行无报错的比例 |
| 澄清率 | 需要澄清对话的比例 |
| 用户满意度 | 反馈评分统计 |

**口径说明**：
- SQL 正确率需基于人工标注或可复现基准集
- 执行成功率与澄清率需记录上下文与版本信息

**回归基准数据格式**：

```json
{
  "test_id": "tc_001",
  "category": "aggregation",
  "difficulty": "medium",

  "input": {
    "question": "统计 2024 年 1 月北京地区的订单总额",
    "context": {
      "database": "ecommerce",
      "dialect": "mysql",
      "user_permissions": ["orders:read", "users:read"]
    },
    "schema_snapshot": "schema_v20240115"
  },

  "expected": {
    "sql": "SELECT SUM(amount) AS total FROM orders WHERE region = '北京' AND created_at >= '2024-01-01' AND created_at < '2024-02-01'",
    "sql_variants": [
      "SELECT SUM(amount) FROM orders WHERE region = '北京' AND YEAR(created_at) = 2024 AND MONTH(created_at) = 1"
    ],
    "result_pattern": {
      "columns": ["total"],
      "row_count": 1,
      "value_ranges": {"total": [0, null]}
    }
  },

  "validation": {
    "sql_match_mode": "semantic",
    "allow_column_alias_diff": true,
    "allow_order_diff": true,
    "execution_required": true
  },

  "metadata": {
    "created_by": "data-team",
    "created_at": "2024-01-15",
    "last_verified": "2024-06-01",
    "tags": ["region", "aggregation", "date_filter"]
  }
}
```

**评测执行规则**：
- CI 集成：每次模型/Prompt 变更触发回归测试
- 通过标准：SQL 正确率 >= 95%，执行成功率 >= 99%
- 失败处理：阻断发布，生成差异报告

### 8.2 监控告警

| 指标 | 告警条件 |
|------|----------|
| 失败率 | > 5% |
| P99 延迟 | > 10s |
| Token 消耗 | 超日均 200% |
| 成本 | 超预算阈值 |

---

## 9. 风险与对策

| 风险 | 对策 |
|------|------|
| AI 生成错误 SQL | 多阶段校验 + EXPLAIN 预检 + 置信度阈值 |
| 越权访问敏感数据 | 列级权限 + 脱敏规则 + 只读连接 |
| 成本失控 | 模型分级 + 缓存复用 + 限流配额 |
| Schema 变更导致失败 | 变更检测 + 缓存刷新 + 降级提示 |

---

## 10. 待定事项

- [ ] 语义层配置管理方式（配置文件 / 管理界面 / API）
- [ ] RAG 语料更新机制与频率
- [ ] 权限与脱敏规则的集成方案
- [ ] 模型分级的具体阈值参数
- [ ] EXPLAIN 风险等级的量化标准（扫描行数 / 成本 / 索引命中）

---

## 11. 实现进度

> 本节跟踪 ai-service 的实现状态

### 11.1 服务骨架

| 模块 | 文件 | 状态 | 说明 |
|------|------|------|------|
| 入口 | `ai-service/src/main.rs` | ✅ 完成 | 服务启动、OpenAPI 文档 |
| 数据模型 | `ai-service/src/models.rs` | ✅ 完成 | 请求/响应结构定义 |
| 应用状态 | `ai-service/src/state.rs` | ✅ 完成 | AI 配置、服务 URL |
| 路由 | `ai-service/src/routes.rs` | ✅ 完成 | API 端点注册 |
| 处理器 | `ai-service/src/handlers.rs` | ✅ 完成 | HTTP 请求处理 |
| 业务逻辑 | `ai-service/src/service.rs` | 🚧 骨架 | 占位实现 |

### 11.2 API 端点

| 端点 | 状态 | 说明 |
|------|------|------|
| `POST /api/ai/query` | 🚧 骨架 | 返回占位响应 |
| `POST /api/ai/clarify` | 🚧 骨架 | 返回占位响应 |
| `POST /api/ai/validate` | ✅ 基础 | 基础校验已实现 |
| `GET /api/health` | ✅ 完成 | 包含 LLM 配置状态 |

### 11.3 核心模块进度

| 模块（3.x 章节） | 实现状态 | 下一步 |
|------------------|----------|--------|
| 3.1 意图解析模块 | 📋 规划 | 需实现 LLM 调用 |
| 3.2 语义层模块 | 📋 规划 | 需设计数据结构 |
| 3.3 RAG 检索模块 | 📋 规划 | 需选型向量数据库 |
| 3.4 SQL 生成模块 | 🚧 骨架 | 需实现 LLM 调用 |
| 3.5 SQL 校验模块 | ✅ 基础 | 可扩展更多规则 |
| 3.6 执行预检模块 | 📋 规划 | 需集成 EXPLAIN |
| 3.7 Schema 管理模块 | 🚧 骨架 | 需调用 connection-service |
| 3.8 数据画像模块 | 📋 规划 | 依赖 Schema 模块 |
| 3.9 失败与降级策略 | 📋 规划 | 需实现熔断机制 |

### 11.4 基础设施进度

| 项目 | 状态 | 说明 |
|------|------|------|
| Cargo.toml | ✅ 完成 | workspace 已配置 |
| Dockerfile | ✅ 优化 | 多阶段构建 + 依赖缓存 + UPX 压缩 |
| docker-compose.yml | ✅ 优化 | 内存限制 + 多模式支持 |
| docker-compose.single.yml | ✅ 新增 | 单容器部署模式 |
| start.sh | ✅ 新增 | 一键启动脚本 |
| .dockerignore | ✅ 新增 | 构建上下文优化 |
| Gateway 代理 | ✅ 完成 | /api/ai/* 路由已配置 |
| ServiceUrls 配置 | ✅ 完成 | ai_service URL 已添加 |
| 聚合健康检查 | ✅ 完成 | ai-service 已纳入 |

### 11.5 部署优化

| 优化项 | 效果 |
|--------|------|
| 依赖缓存层 | 重复构建从 10 分钟降至 1-2 分钟 |
| UPX 压缩 | 二进制体积减小 50-70% |
| scratch 镜像 | 最终镜像约 10-20MB |
| 单容器模式 | 内存占用从 ~400MB 降至 ~200MB |
| 内存限制 | 防止单服务内存泄漏影响系统 |

部署模式：

| 模式 | 容器 | 内存 | 适用场景 |
|------|------|------|----------|
| `./start.sh single` | 1 | ~200MB | 开发测试 |
| `./start.sh multi` | 4 | ~400MB | 生产环境 |
| `./start.sh local` | 0 | ~150MB | 本地调试 |

### 11.6 图例

| 标记 | 含义 |
|------|------|
| ✅ 完成 | 功能已实现并可用 |
| 🚧 骨架 | 代码结构已创建，逻辑待实现 |
| 📋 规划 | 仅有设计，代码未开始 |