# AI 功能架构

> 详细设计请参阅 [AI_架构设计.md](../../AI_架构设计.md)

## 1. 概述

AI 功能旨在将智能查询能力贯穿查询生命周期，构建可控、可审计、可评测、可扩展的智能查询体系。

### 1.1 核心能力

| 能力 | 说明 | 状态 |
|------|------|------|
| Text2SQL | 自然语言转 SQL 查询 | 🚧 开发中 |
| 语义理解 | 指标、维度、口径的统一建模 | 📋 规划 |
| RAG 增强 | 历史 SQL、FAQ、指标定义的检索增强 | 📋 规划 |
| 安全治理 | 权限控制、数据脱敏、只读执行、审计追溯 | 🚧 部分实现 |

### 1.2 设计原则

- **最小权限**：默认只读，逐层授权
- **可解释**：所有生成与执行均可审计追溯
- **可回归**：内置评测集与 CI 回归机制
- **可扩展**：模型与检索源支持热插拔

## 2. 架构设计

### 2.1 分层架构

```
┌─────────────────────────────────────────────────────────┐
│                      表现层                              │
│         交互界面 · 多轮对话 · SQL 编辑与解释              │
├─────────────────────────────────────────────────────────┤
│                    AI 编排层                             │
│      意图解析 · 生成验证 · 执行链路 · 策略路由            │
├─────────────────────────────────────────────────────────┤
│                   数据语义层                             │
│         指标定义 · 维度管理 · 口径规则 · 数据画像         │
├─────────────────────────────────────────────────────────┤
│                   数据访问层                             │
│          Schema 管理 · 连接池 · 只读执行器               │
├─────────────────────────────────────────────────────────┤
│                     治理层                               │
│       权限控制 · 数据脱敏 · 审计日志 · 监控告警           │
└─────────────────────────────────────────────────────────┘
```

### 2.2 核心流程

```
用户输入 ──▶ 意图解析 ──▶ 语义补全 ──▶ RAG 检索
                                          │
    ┌─────────────────────────────────────┘
    ▼
SQL 生成 ──▶ 规则校验 ──▶ EXPLAIN 预检 ──▶ 执行查询
                                          │
    ┌─────────────────────────────────────┘
    ▼
结果解释 ──▶ 审计记录 ──▶ 用户反馈 ──▶ 闭环优化
```

## 3. 模块设计

### 3.1 意图解析模块

**职责**：理解用户查询意图，必要时触发澄清对话

| 意图类型 | 示例 |
|----------|------|
| 筛选查询 | "查找北京地区的用户" |
| 聚合统计 | "统计每月订单总额" |
| 趋势分析 | "最近 30 天的销售趋势" |
| 对比分析 | "对比 Q1 和 Q2 的收入" |

**澄清触发条件**：
- 时间范围缺失
- 指标口径不明确
- 维度粒度模糊

### 3.2 语义层模块

**职责**：统一业务术语与数据模型的映射

```
业务名词 ──▶ 标准指标/维度 ──▶ 物理字段
   │              │               │
 "销售额"     metric:gmv      orders.amount
```

### 3.3 RAG 检索模块

**职责**：检索相关上下文增强生成质量

| 语料类型 | 用途 |
|----------|------|
| 历史 SQL | 相似查询复用 |
| FAQ | 常见问题直接匹配 |
| 指标定义 | 口径与计算逻辑 |
| 示例问答 | Few-shot 参考 |

### 3.4 SQL 生成模块

**输入**：
- 用户问题 + 对话历史
- Schema 信息
- 语义层定义
- RAG 检索结果

**输出**：
- SQL 语句
- 自然语言解释
- 置信度评分
- 引用来源

### 3.5 SQL 校验模块

| 规则 | 说明 |
|------|------|
| 只读检查 | 仅允许 SELECT 语句 |
| 单语句限制 | 禁止多语句执行 |
| 关键词过滤 | 拦截危险操作 |
| LIMIT 强制 | 默认添加结果限制 |
| 字段校验 | 验证字段存在性 |

## 4. 数据模型

### 4.1 自然语言查询请求

```rust
pub struct NaturalQueryRequest {
    pub request_id: String,
    pub question: String,
    pub connection_id: String,
    pub context: Option<ConversationContext>,
    pub user_permissions: Vec<String>,
}
```

### 4.2 查询响应

```rust
pub struct NaturalQueryResponse {
    pub request_id: String,
    pub trace_id: String,
    pub status: QueryStatus,  // ready / need_clarification / failed
    pub sql: Option<String>,
    pub explanation: Option<String>,
    pub confidence: Option<f64>,
    pub references: Vec<SqlReference>,
    pub clarification: Option<ClarificationQuestion>,
    pub lineage_summary: Option<LineageSummary>,
}
```

## 5. 安全设计

### 5.1 权限评估时机

| 阶段 | 检查项 |
|------|--------|
| 请求入口 | 用户身份、会话有效性 |
| RAG 检索前 | 语料可见性过滤 |
| SQL 生成前 | Schema 可见范围 |
| SQL 生成后 | 表/列访问权限 |
| 执行前 | 二次校验 + 行级过滤 |
| 返回前 | 敏感列脱敏 |

### 5.2 数据脱敏

| 类型 | 脱敏规则 |
|------|----------|
| 手机号 | `138****8888` |
| 邮箱 | `a***@example.com` |
| 身份证 | `110***********1234` |
| 银行卡 | `6222 **** **** 1234` |

## 6. 成本控制

### 6.1 模型分级

| 级别 | 场景 | 特点 |
|------|------|------|
| 快速模型 | 简单查询、澄清对话 | 低延迟、低成本 |
| 高精度模型 | 复杂分析、多表关联 | 高准确率 |

### 6.2 路由规则

| 判定维度 | 快速模型 | 高精度模型 |
|----------|----------|------------|
| 涉及表数量 | <= 2 | > 2 |
| 预估 Token 数 | <= 2000 | > 2000 |
| 查询复杂度 | 无 JOIN / 子查询 | 包含复杂语法 |

## 7. 实现进度

| 模块 | 状态 | 说明 |
|------|------|------|
| 服务骨架 | ✅ 完成 | main.rs, models.rs, handlers.rs |
| API 端点 | ✅ 完成 | /query, /clarify, /validate |
| SQL 校验 | ✅ 基础 | 只读检查、关键词过滤 |
| LLM 调用 | 🚧 开发中 | 待实现 call_llm |
| Schema 获取 | 🚧 开发中 | 待集成 connection-service |
| RAG 检索 | 📋 规划 | 需选型向量数据库 |
| 语义层 | 📋 规划 | 需设计数据结构 |

---

> 完整设计文档：[AI_架构设计.md](../../AI_架构设计.md)
