# 系统架构概览

## 1. 项目简介

DatabaseManager 是一个高性能数据库管理后端系统，基于 Rust 微服务架构构建，支持多种数据库的连接管理和 SQL 查询执行，并集成 AI 智能查询能力。

### 1.1 核心目标

- 安全地管理多种数据库连接（MySQL / PostgreSQL / SQLite / Redis / MongoDB 等）
- 提供 SQL 查询执行与结果解析
- 集成 AI 能力实现自然语言转 SQL（Text2SQL）
- 保证安全性、可审计性、可扩展性

### 1.2 技术栈

| 组件 | 技术选型 | 说明 |
|------|---------|------|
| 语言 | Rust | 高性能、内存安全 |
| Web 框架 | Axum 0.8 | 异步 Web 框架，基于 Tower 生态 |
| 异步运行时 | Tokio | 全功能异步运行时 |
| 数据库访问 | SQLx | 编译时 SQL 检查，多数据库支持 |
| 序列化 | Serde | JSON 序列化/反序列化 |
| 日志 | tracing | 结构化日志，支持分布式追踪 |
| 错误处理 | thiserror | 自定义错误类型 |
| API 文档 | Utoipa | OpenAPI 3.0 自动生成 |
| 容器化 | Docker | 多阶段构建，Alpine 基础镜像 |

## 2. 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                          客户端 (前端/API)                           │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │ HTTP/JSON
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        Gateway (8080)                                │
│                                                                      │
│   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐   │
│   │  CORS    │  │  Trace   │  │RequestID │  │   路由转发        │   │
│   └──────────┘  └──────────┘  └──────────┘  └──────────────────┘   │
└────────┬────────────────┬────────────────┬──────────────────────────┘
         │                │                │
         ▼                ▼                ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  Connection     │ │  Query          │ │  AI             │
│  Service        │ │  Service        │ │  Service        │
│  (8081)         │ │  (8082)         │ │  (8083)         │
│                 │ │                 │ │                 │
│ ┌─────────────┐ │ │ ┌─────────────┐ │ │ ┌─────────────┐ │
│ │PoolManager  │ │ │ │QueryExecutor│ │ │ │Text2SQL    │ │
│ │             │ │ │ │             │ │ │ │            │ │
│ │ ┌─────────┐ │ │ │ │ ┌─────────┐ │ │ │ │ ┌────────┐ │ │
│ │ │MySQL    │ │ │ │ │ │Validator│ │ │ │ │ │LLM API │ │ │
│ │ │Postgres │ │ │ │ │ │Parser   │ │ │ │ │ │RAG     │ │ │
│ │ │SQLite   │ │ │ │ │ └─────────┘ │ │ │ │ │Schema  │ │ │
│ │ └─────────┘ │ │ │ └─────────────┘ │ │ │ └────────┘ │ │
│ └─────────────┘ │ └─────────────────┘ │ └─────────────┘ │
└────────┬────────┘ └────────┬─────────┘ └────────┬───────┘
         │                   │                    │
         └───────────────────┼────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          外部数据库                                   │
│                                                                      │
│   ┌─────────┐  ┌────────────┐  ┌─────────┐  ┌─────────┐  ┌───────┐ │
│   │  MySQL  │  │ PostgreSQL │  │ SQLite  │  │  Redis  │  │MongoDB│ │
│   └─────────┘  └────────────┘  └─────────┘  └─────────┘  └───────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

## 3. 设计原则

### 3.1 架构原则

| 原则 | 说明 |
|------|------|
| 微服务架构 | 服务独立部署、独立扩展、故障隔离 |
| 分层设计 | 路由层 → 服务层 → 数据访问层，职责清晰 |
| 依赖注入 | 通过 AppState 共享依赖，便于测试 |
| 异步优先 | 全链路异步，最大化吞吐量 |

### 3.2 安全原则

| 原则 | 说明 |
|------|------|
| 最小权限 | 默认只读，逐层授权 |
| 安全优先 | 密码不落日志、SQL 注入防护 |
| 可审计 | 所有操作记录审计日志 |
| 数据脱敏 | 敏感字段脱敏展示 |

### 3.3 可观测性

| 能力 | 实现方式 |
|------|----------|
| 日志 | tracing + JSON 格式结构化日志 |
| 追踪 | Request ID 全链路透传 |
| 健康检查 | 各服务 /api/health 端点 |
| 聚合监控 | Gateway /api/health/all 聚合检查 |

## 4. 请求处理流程

```
HTTP Request
    │
    ▼
┌───────────────┐
│   Gateway     │ ← 路由匹配、中间件处理
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  Proxy        │ ← 请求转发到目标服务
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  Service      │ ← 业务逻辑处理
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  Database     │ ← 数据操作
└───────┬───────┘
        │
        ▼
HTTP Response (JSON)
```

## 5. 目录结构

```
DatabaseManager/
├── Cargo.toml                 # Workspace 配置
├── Cargo.lock                 # 依赖锁定
├── Dockerfile                 # 多阶段构建
├── docker-compose.yml         # 容器编排
│
├── common/                    # 共享模块
│   ├── Cargo.toml
│   └── src/
│       ├── lib.rs             # 模块导出
│       ├── config.rs          # 配置管理
│       ├── errors.rs          # 错误处理
│       ├── response.rs        # API 响应
│       ├── middleware/        # 中间件
│       ├── models/            # 数据模型
│       └── utils/             # 工具函数
│
├── gateway/                   # API 网关 (8080)
├── connection-service/        # 连接管理 (8081)
├── query-service/             # 查询执行 (8082)
├── ai-service/                # AI 智能 (8083)
│
└── docs/                      # 技术文档
```

## 6. 技术决策记录

### 6.1 为什么选择 Rust？

- **性能**：接近 C/C++ 的运行速度
- **安全**：编译时内存安全检查
- **并发**：无畏并发，无数据竞争
- **生态**：Tokio/Axum 成熟的异步生态

### 6.2 为什么选择微服务架构？

- **独立部署**：各服务可独立发布
- **技术异构**：AI 服务可使用不同技术栈
- **故障隔离**：单服务故障不影响全局
- **团队协作**：多团队并行开发

### 6.3 为什么选择 Axum？

- **性能优异**：基于 hyper，性能一流
- **类型安全**：编译时路由检查
- **生态整合**：Tower 中间件生态
- **异步原生**：全异步设计
